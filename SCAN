-- Wrap the Geoscanner peripheral on the right side.
local geoscanner = peripheral.wrap("right")

-- Check if Geoscanner peripheral is found.
if geoscanner then
    -- Define the coordinates of the current chunk.
    local chunkX, chunkZ = math.floor(gps.locate())
    local minY, maxY = 77, 77  -- Set the Y-level range from -20 to 30.

    -- Initialize progress variables.
    local totalBlocks = (maxY - minY + 1) * 16 * 16
    local scannedBlocks = 0

    -- Delete the existing "BLOCKS.txt" file if it exists.
    if fs.exists("BLOCKS.txt") then
        fs.delete("BLOCKS.txt")
    end

    -- Open the "BLOCKS.txt" file for writing.
    local file = fs.open("BLOCKS.txt", "w")

    -- Create a function to update the progression bar.
    local function updateProgress()
        term.clear()
        term.setCursorPos(1, 1)
        print("Scanning Progress: " .. scannedBlocks .. " / " .. totalBlocks)

        local progress = scannedBlocks / totalBlocks
        local barLength = 20
        local progressChars = math.floor(barLength * progress)
        local progressBar = "[" .. string.rep("=", progressChars) .. string.rep(" ", barLength - progressChars) .. "]"
        print("Progress: " .. progressBar)
    end

    -- Iterate through the chunk and scan for blocks.
    for y = minY, maxY do
        for x = 1, 16 do
            for z = 1, 16 do
                local blockData = geoscanner.scan(x, y, z)
                scannedBlocks = scannedBlocks + 1

                -- Update progress.
                updateProgress()

                if blockData then
                    local blockName = blockData.name
                    local blockAmount = blockData.count

                    -- Write block information to the file.
                    file.writeLine("Block: " .. blockName)
                    file.writeLine("Amount: " .. blockAmount)
                    file.writeLine("Coordinates: X=" .. chunkX * 16 + x .. " Y=" .. y .. " Z=" .. chunkZ * 16 + z)
                    file.writeLine("--------")
                end
            end
        end
    end

    -- Close the file.
    file.close()

    -- Display a completion message.
    term.clear()
    term.setCursorPos(1, 1)
    print("Scan results saved to 'BLOCKS.txt'")
else
    -- Display a message if the Geoscanner is not found.
    print("Geoscanner not found.")
end
